<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><title>關於 Python Descriptor 的一個實用範例 (lazy operator) - A&rsquo;Khun</title><link rel=stylesheet href=/css/main.min.82e0d212964fcf37668e5bfc692b25a2cf8cd81a7787eee2bec090f5eb01cd65.css integrity="sha256-guDSEpZPzzdmjlv8aSslos+M2Bp3h+7ivsCQ9esBzWU=" crossorigin=anonymous media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Didact+Gothic"><meta name=twitter:card content="summary"><meta name=twitter:title content="關於 Python Descriptor 的一個實用範例 (lazy operator)"><meta name=twitter:description content="最近在看 Mastering Python Design Patterns。看到這個例子很有趣，他延遲了某些運算成本比較高的 member variable 的初始化時間。
class LazyProperty: def __init__(self, method): self.method = method self.method_name = method.__name__ print('function overriden: {}'.format(self.method)) print('function\'s name: {}'.format(self.method_name)) def __get__(self, obj, cls): if not obj: return None value = self.method(obj) setattr(obj, self.method_name, value) return value class Test: def __init__(self): self.x = 'foo' self.y = 'bar' self._resource = None @LazyProperty def resource(self): print('initializing self._resource which is: {}'.format(self._resource)) self._resource = tuple(range(5)) return self._resource def main(): t = Test() print(t.x) print(t.y) print(t.resource) print(t.resource) if __name__ == '__main__': main() 輸出的結果如下"><meta property="og:url" content="https://akhun.co/posts/2015/%E9%97%9C%E6%96%BC-python-descriptor-%E7%9A%84%E4%B8%80%E5%80%8B%E5%AF%A6%E7%94%A8%E7%AF%84%E4%BE%8B-lazy-operator/"><meta property="og:site_name" content="A'Khun"><meta property="og:title" content="關於 Python Descriptor 的一個實用範例 (lazy operator)"><meta property="og:description" content="最近在看 Mastering Python Design Patterns。看到這個例子很有趣，他延遲了某些運算成本比較高的 member variable 的初始化時間。
class LazyProperty: def __init__(self, method): self.method = method self.method_name = method.__name__ print('function overriden: {}'.format(self.method)) print('function\'s name: {}'.format(self.method_name)) def __get__(self, obj, cls): if not obj: return None value = self.method(obj) setattr(obj, self.method_name, value) return value class Test: def __init__(self): self.x = 'foo' self.y = 'bar' self._resource = None @LazyProperty def resource(self): print('initializing self._resource which is: {}'.format(self._resource)) self._resource = tuple(range(5)) return self._resource def main(): t = Test() print(t.x) print(t.y) print(t.resource) print(t.resource) if __name__ == '__main__': main() 輸出的結果如下"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-04T05:10:44+08:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Descriptor"><title>關於 Python Descriptor 的一個實用範例 (lazy operator)</title></head><body><header class="wrap flex-container"><h1>關於 Python Descriptor 的一個實用範例 (lazy operator)</h1></header><main class=wrap><div class=flex-container><aside role=complementary>Wed Sep 23, 2015 &#183; 259 words<div class=tag-container><span class=tag><a href=/tags/python/>python
</a></span><span class=tag><a href=/tags/descriptor/>descriptor</a></span></div></aside><hr><article role=article><p>最近在看 <a href="http://www.tenlong.com.tw/items/9864340417?item_id=1006942">Mastering Python Design Patterns</a>。看到這個例子很有趣，他延遲了某些運算成本比較高的 member variable 的初始化時間。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LazyProperty</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, method):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>method <span style=color:#f92672>=</span> method
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>method_name <span style=color:#f92672>=</span> method<span style=color:#f92672>.</span>__name__
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;function overriden: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>method))
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;function</span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74>s name: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>method_name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__get__</span>(self, obj, cls):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> obj:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>method(obj)
</span></span><span style=display:flex><span>        setattr(obj, self<span style=color:#f92672>.</span>method_name, value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;foo&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;bar&#39;</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@LazyProperty</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>resource</span>(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;initializing self._resource which is: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>_resource))
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_resource <span style=color:#f92672>=</span> tuple(range(<span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>_resource
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>    t <span style=color:#f92672>=</span> Test()
</span></span><span style=display:flex><span>    print(t<span style=color:#f92672>.</span>x)
</span></span><span style=display:flex><span>    print(t<span style=color:#f92672>.</span>y)
</span></span><span style=display:flex><span>    print(t<span style=color:#f92672>.</span>resource)
</span></span><span style=display:flex><span>    print(t<span style=color:#f92672>.</span>resource)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    main()
</span></span></code></pre></div><p>輸出的結果如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#66d9ef>function</span> overriden: &lt;<span style=color:#66d9ef>function</span> Test.resource at 0x10b0fc9d8&gt;
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span><span style=color:#960050;background-color:#1e0010>&#39;</span>s name: resource
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>bar
</span></span><span style=display:flex><span>initializing self._resource which is: None
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>0, 1, 2, 3, 4<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>0, 1, 2, 3, 4<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>可以發現 resource 的 initialization 只被執行過一次！原因是因為 descriptor 只有定義 <code>__get__</code>，所以 descriptor 在第一次執行 <code>__get__</code> 的時候，就被 <code>setattr(obj, self.method_name, value)</code> 這行取代了，讓第二次的取值，變成直接拿值，而不是再次執行 <code>__get__</code>。</p><p>這招實在太酷炫了，趕快記下來！</p></article><asie role=note class=see-also></aside></div><nav role=navigation class="flex-container bottom-menu"><hr><p><a href=/notes>notes</a>
&#183;
<a href=/posts>posts</a>
&#183;
<a href=/about>about</a>
&#183;
<a href=/>home</a></p></nav></main><footer class="flex-container footer">盒仔內 ê 時間</footer></body></html>